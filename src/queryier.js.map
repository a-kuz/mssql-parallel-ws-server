{"version":3,"file":"queryier.js","sourceRoot":"./src/","sources":["queryier.ts"],"names":[],"mappings":"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","sourcesContent":["import * as util from 'util';\r\nimport { readFileSync, appendFileSync } from 'fs';\r\nimport { ConnectionPool, IRecordSet, IResult, IRow } from 'mssql'\r\nimport { config, IOptions } from 'mssql'\r\nimport * as mssql from 'mssql'\r\nimport * as ws from 'socket.io'\r\nimport { type } from 'os';\r\nvar perf_last: number = Date.now();\r\nexport class Querier {\r\n    constructor(strQ: string = \"\") {\r\n        let serversJSON = readFileSync('config\\/servers.json').toString()\r\n        Querier.servers = JSON.parse(serversJSON).sort(() => Math.random() > 0.5 ? 0 : -1)\r\n        //JSON.parse(readFileSync('config\\/servers.json').toString()).sort(() => Math.random() > 0.5 ? 0 : -1)\r\n        // this.resultTable = []\r\n        this.strQ = strQ\r\n    }\r\n    private doned: number = 0\r\n    private fullDoned: number = 0\r\n    static servers: any[] = JSON.parse(\r\n        readFileSync('config\\/servers.json').toString()\r\n    ).sort(() => Math.random() > 0.5 ? 0 : -1)\r\n    private TsqlQuery: string\r\n    \r\n    public set strQ(v: string) {\r\n        this.TsqlQuery = v;\r\n    }\r\n    public get strQ(): string {\r\n        return this.TsqlQuery;\r\n    }\r\n    // private resultTable: any[] = []\r\n    private socket: ws.Socket\r\n    public setSocket(socket: ws.Socket) {\r\n        this.socket = socket;\r\n        socket.emit(\"start\", { totalInstances: (Querier.servers.length) })\r\n    }\r\n    async executeSQL(connectionString: config): Promise<IResult<IRow>> {\r\n        // try {\r\n        let pool: ConnectionPool\r\n        let conn: ConnectionPool\r\n        var result: IResult<any>\r\n        const q: TemplateStringsArray = this.strQ as any\r\n        pool = await new ConnectionPool(connectionString)\r\n        conn = await pool.connect()\r\n        result = await conn.query(q)\r\n        await pool.close()\r\n        return result\r\n    }\r\n\r\n    async processingCallback(server, i: number)  {\r\n        console.log(server)\r\n        //this.doned = this.doned + 1\r\n        let j = 0\r\n        let ob: any\r\n        let q = this.strQ\r\n        var result\r\n        var error\r\n        try {\r\n            let o: IOptions = { connectTimeout: 3900, maxRetriesOnTransientErrors: 1, \"requestTimeout\": 500000, \"trustedConnection\": false }\r\n            let c: config = {\r\n                database: 'sup_kkm',\r\n                server: server.insance,\r\n                connectionTimeout: 3900, user: 'sa', password: 'ser09l', requestTimeout: 500000, options: o\r\n            }\r\n            result =  (await this.executeSQL(c)).recordset\r\n        }\r\n        catch (err) {\r\n            error = err\r\n            console.groupCollapsed(`err: ${err}`);\r\n            console.log(server.code);\r\n            console.groupEnd();\r\n            ob = [{ ib: server.insance, err }]\r\n            return ob\r\n        } finally {\r\n            const recordset: IRecordSet<any> | Error = result\r\n            // if (this.resultTable.length === 0) {\r\n            //     this.resultTable = [recordset]\r\n            // }\r\n            if (recordset == undefined) { ob = [{ id: -1, ib: server.code }] } else {\r\n                ob = (recordset as IRecordSet<any>).map((el) => {\r\n                    j++\r\n                    el.ib = server.code\r\n                    let ib_host: string = server.host.replace(/ost/, 'serv')\r\n                    el.ib_href = `http://${ib_host}:85/sup_kkm`\r\n                    el.id = ((i * 10000) + j)\r\n                    return el\r\n                })\r\n            }\r\n            // this.resultTable = this.resultTable.concat([...ob])\r\n            return ob\r\n        }\r\n    }\r\n    async processing(): Promise<any> {\r\n        //this.doned = 0\r\n        console.log('processing')\r\n        var j: number\r\n        return Querier.servers.map((e,i)=>{\r\n            return this.processingCallback(e,i)\r\n\r\n        })\r\n    }\r\n    async execQueries() {\r\n        var f: Promise<any>[]\r\n        \r\n        for await (const obj of (await this.processing())) {\r\n            \r\n            let str = ''\r\n            try {\r\n                if (obj.length) {\r\n                    obj.forEach(element => {\r\n                        Object.keys(element).forEach(key => {\r\n                            if (Buffer.isBuffer(element[key])) {\r\n                                element[key] = buf2hex(element[key]);\r\n                            }\r\n                        });\r\n                    });\r\n                    if (this.socket) {\r\n                        this.socket.send(obj)\r\n                        console.timeStamp(obj[0].ib)\r\n                        this.fullDoned++\r\n                        // tslint:disable-next-line: max-line-length\r\n                        this.socket.emit(\"progress\", { value: (this.fullDoned / Querier.servers.length * 100), bufferValue: (this.doned / Querier.servers.length * 100) })\r\n                        console.log(`${perf_last - Date.now()} ${this.fullDoned} / ${Querier.servers.length} (${this.doned})`)\r\n                        perf_last = Date.now()\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error(e)\r\n                console.log(obj)\r\n            }\r\n        }\r\n        if (this.socket) {\r\n            // this.socket.send(JSON.stringify(this.resultTable))\r\n            this.socket.emit('end')\r\n        }\r\n    }\r\n}\r\nfunction buf2hex(buffer) { // buffer is an ArrayBuffer\r\n    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');\r\n}"]}