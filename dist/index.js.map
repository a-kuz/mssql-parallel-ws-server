{"version":3,"file":"index.js","sourceRoot":"./src/","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as iio from 'socket.io'\r\nvar s: iio.Server = require('socket.io')\r\nimport { Querier } from './queryier';\r\nimport { appendFile, WriteFileOptions, readFile, readFileSync } from 'fs';\r\nimport { hostname } from 'os';\r\nconst HISTORY_PATH = \"sql_history.log\";\r\n`   1   3`\r\n\r\nvar PORT = process.env.PORT || 3002\r\nlet li = s.listen(PORT)\r\n    .on('connect', (socket: iio.Socket) => {\r\n\r\n        socket.on(\"message\", async data => {\r\n            // console.log(\"data: \", data)        \r\n            appendFile(HISTORY_PATH,\r\n                String.fromCharCode(1) +\r\n                String.fromCharCode(2) +\r\n                Date() +\r\n                String.fromCharCode(10) +\r\n                String.fromCharCode(3) +\r\n                data + String.fromCharCode(10)\r\n                , err => { })\r\n            var q = new Querier(data)\r\n            socket.emit(\"start\", { totalInstances: 252 })\r\n            q.setSocket(socket)\r\n            q.execQueries();\r\n\r\n\r\n        }).on('history', async data => {\r\n            var history: string[] = []\r\n            var content = (readFileSync('sql_history.log')).toString()\r\n            var sp: string[] = content.split(String.fromCharCode(10) +\r\n                String.fromCharCode(3))\r\n\r\n            var t: string\r\n            var sep = String.fromCharCode(1) + String.fromCharCode(2)\r\n            sp = sp.slice(-900)\r\n            for (t of sp) {\r\n                // console.log(t)\r\n                let t2 = t.split(sep)\r\n                history.push(t2[0])\r\n            }\r\n            let h = []\r\n            // tslint:disable-next-line: max-line-length\r\n            history = history.filter((e: string) => (e.length > 20 ? 1 : 0)).map(el => el.trim())\r\n            h = history.filter((el, i) => {\r\n                if (history.lastIndexOf(el) == i) {\r\n                    return 1\r\n                }\r\n            }).map(e => {\r\n                return { text: e, full: false }\r\n            })\r\n            socket.emit('history', h.reverse())\r\n        })\r\n\r\n    })\r\n\r\n\r\n\r\nli.on(\"connection\", socket => {\r\n    console.log('connection ', socket.handshake.address)\r\n\r\n    socket.emit(\"serverList\", Querier.servers)\r\n})\r\nli.on(\"message\", data => {\r\n    console.log(\"li_data: \", data)\r\n}).on(\"serverList\", async data => {\r\n    console.log(\"serverList\", Querier.servers)\r\n\r\n})\r\nconsole.log(`WebSockets started on ${hostname()}:${PORT}`)\r\nif (process.argv.includes('stop')) {\r\n    console.log(`args includes ''stop''. Stoping`)\r\n    li.removeAllListeners()\r\n    li.server.close()\r\n    process.exit(0)\r\n}"]}